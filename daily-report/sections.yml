meta:
  title: 'Pacific Coast Title - Daily Executive Report'
  show_day_banner: true

sections:
  - name: 'Title Division'
    subtables:
      - id: 'title_openings'
        title: 'New Openings Today'
        sql: |
          SELECT 
            od.file_number as 'File Number',
            od.full_address as 'Property Address',
            CONCAT(cbd.customer_first_name, ' ', cbd.customer_last_name) as 'Customer',
            CONCAT('$', FORMAT(od.sales_price, 0)) as 'Sales Price',
            od.transaction_type as 'Type',
            CONCAT(sr.first_name, ' ', sr.last_name) as 'Sales Rep',
            sr.branch_location as 'Branch'
          FROM pct_order_details od
          LEFT JOIN customer_basic_details cbd ON od.customer_id = cbd.id
          LEFT JOIN sales_reps sr ON od.sales_rep = sr.id
          WHERE DATE(od.created_at) = CURDATE()
          AND sr.division = 'Title'
          AND od.status != 'cancelled'
          ORDER BY od.created_at DESC;
        transforms: []
      
      - id: 'title_closings'
        title: 'Closings Completed Today'
        sql: |
          SELECT 
            od.file_number as 'File Number',
            od.full_address as 'Property Address',
            CONCAT(cbd.customer_first_name, ' ', cbd.customer_last_name) as 'Customer',
            CONCAT('$', FORMAT(od.sales_price, 0)) as 'Sales Price',
            od.transaction_type as 'Type',
            CONCAT(sr.first_name, ' ', sr.last_name) as 'Sales Rep',
            sr.branch_location as 'Branch'
          FROM pct_order_details od
          LEFT JOIN customer_basic_details cbd ON od.customer_id = cbd.id
          LEFT JOIN sales_reps sr ON od.sales_rep = sr.id
          WHERE DATE(od.closing_date) = CURDATE()
          AND sr.division = 'Title'
          AND od.status = 'closed'
          ORDER BY od.closing_date DESC;
        transforms: []

  - name: 'Escrow Division'
    subtables:
      - id: 'escrow_openings'
        title: 'New Openings Today'
        sql: |
          SELECT 
            od.file_number as 'File Number',
            od.full_address as 'Property Address',
            CONCAT(cbd.customer_first_name, ' ', cbd.customer_last_name) as 'Customer',
            CONCAT('$', FORMAT(od.sales_price, 0)) as 'Sales Price',
            od.transaction_type as 'Type',
            CONCAT(sr.first_name, ' ', sr.last_name) as 'Sales Rep',
            sr.branch_location as 'Branch'
          FROM pct_order_details od
          LEFT JOIN customer_basic_details cbd ON od.customer_id = cbd.id
          LEFT JOIN sales_reps sr ON od.sales_rep = sr.id
          WHERE DATE(od.created_at) = CURDATE()
          AND sr.division = 'Escrow'
          AND od.status != 'cancelled'
          ORDER BY od.created_at DESC;
        transforms: []
      
      - id: 'escrow_closings'
        title: 'Closings Completed Today'
        sql: |
          SELECT 
            od.file_number as 'File Number',
            od.full_address as 'Property Address',
            CONCAT(cbd.customer_first_name, ' ', cbd.customer_last_name) as 'Customer',
            CONCAT('$', FORMAT(od.sales_price, 0)) as 'Sales Price',
            od.transaction_type as 'Type',
            CONCAT(sr.first_name, ' ', sr.last_name) as 'Sales Rep',
            sr.branch_location as 'Branch'
          FROM pct_order_details od
          LEFT JOIN customer_basic_details cbd ON od.customer_id = cbd.id
          LEFT JOIN sales_reps sr ON od.sales_rep = sr.id
          WHERE DATE(od.closing_date) = CURDATE()
          AND sr.division = 'Escrow'
          AND od.status = 'closed'
          ORDER BY od.closing_date DESC;
        transforms: []

  - name: 'Executive Summary'
    subtables:
      - id: 'daily_metrics'
        title: 'Key Performance Indicators'
        sql: |
          SELECT 
            'Total Openings Today' as 'Metric',
            COUNT(*) as 'Value'
          FROM pct_order_details od
          LEFT JOIN sales_reps sr ON od.sales_rep = sr.id
          WHERE DATE(od.created_at) = CURDATE()
          AND od.status != 'cancelled'
          
          UNION ALL
          
          SELECT 
            'Total Closings Today' as 'Metric',
            COUNT(*) as 'Value'
          FROM pct_order_details od
          LEFT JOIN sales_reps sr ON od.sales_rep = sr.id
          WHERE DATE(od.closing_date) = CURDATE()
          AND od.status = 'closed'
          
          UNION ALL
          
          SELECT 
            'Total Revenue Today' as 'Metric',
            CONCAT('$', FORMAT(SUM(od.sales_price), 0)) as 'Value'
          FROM pct_order_details od
          LEFT JOIN sales_reps sr ON od.sales_rep = sr.id
          WHERE DATE(od.closing_date) = CURDATE()
          AND od.status = 'closed'
          
          UNION ALL
          
          SELECT 
            'Average Transaction Value' as 'Metric',
            CONCAT('$', FORMAT(AVG(od.sales_price), 0)) as 'Value'
          FROM pct_order_details od
          LEFT JOIN sales_reps sr ON od.sales_rep = sr.id
          WHERE DATE(od.closing_date) = CURDATE()
          AND od.status = 'closed';
        transforms: []

  - name: 'Branch Performance'
    subtables:
      - id: 'branch_summary'
        title: 'Revenue by Branch'
        sql: |
          SELECT 
            sr.branch_location as 'Branch',
            sr.division as 'Division',
            COUNT(od.id) as 'Closings Today',
            CONCAT('$', FORMAT(SUM(od.sales_price), 0)) as 'Revenue Today',
            CONCAT('$', FORMAT(AVG(od.sales_price), 0)) as 'Avg Transaction'
          FROM pct_order_details od
          LEFT JOIN sales_reps sr ON od.sales_rep = sr.id
          WHERE DATE(od.closing_date) = CURDATE()
          AND od.status = 'closed'
          AND sr.branch_location IS NOT NULL
          GROUP BY sr.branch_location, sr.division
          ORDER BY SUM(od.sales_price) DESC;
        transforms: []

  - name: 'R-14 Sales Rep Performance'
    subtables:
      - id: 'sales_rep_performance'
        title: 'Sales Representative Production Analysis'
        sql: |
          SELECT 
            CONCAT(sr.first_name, ' ', sr.last_name) as 'Sales Representative',
            sr.branch_location as 'Branch',
            CONCAT(FORMAT((COUNT(CASE WHEN od.status = 'closed' THEN 1 END) / COUNT(*)) * 100, 1), '%') as 'Closing Ratio',
            COUNT(CASE WHEN DATE(od.closing_date) = CURDATE() AND od.transaction_type = 'title_resale' THEN 1 END) as 'Title Resale Today',
            COUNT(CASE WHEN DATE(od.closing_date) = CURDATE() AND od.transaction_type = 'title_refi' THEN 1 END) as 'Title Refi Today',
            COUNT(CASE WHEN DATE(od.closing_date) = CURDATE() AND od.transaction_type = 'escrow' THEN 1 END) as 'Escrow Today',
            CONCAT('$', FORMAT(SUM(CASE WHEN DATE(od.closing_date) = CURDATE() THEN od.sales_price ELSE 0 END), 0)) as 'Revenue Today'
          FROM sales_reps sr
          LEFT JOIN pct_order_details od ON sr.id = od.sales_rep
          WHERE sr.active = 1
          GROUP BY sr.id, sr.first_name, sr.last_name, sr.branch_location
          ORDER BY sr.branch_location, (COUNT(CASE WHEN od.status = 'closed' THEN 1 END) / COUNT(*)) DESC;
        transforms: []

  - name: 'Escrow Officer Performance'
    subtables:
      - id: 'escrow_officer_performance'
        title: 'Escrow Officer Production Analysis'
        sql: |
          SELECT 
            CONCAT(eo.first_name, ' ', eo.last_name) as 'Escrow Officer',
            eo.branch_location as 'Branch',
            CONCAT(FORMAT(eo.closing_efficiency, 1), '%') as 'Closing Efficiency',
            COUNT(CASE WHEN DATE(od.closing_date) = CURDATE() AND od.transaction_type = 'purchase' THEN 1 END) as 'Purchase Today',
            COUNT(CASE WHEN DATE(od.closing_date) = CURDATE() AND od.transaction_type = 'refinance' THEN 1 END) as 'Refinance Today',
            COUNT(CASE WHEN DATE(od.closing_date) = CURDATE() AND od.transaction_type = 'commercial' THEN 1 END) as 'Commercial Today',
            CONCAT('$', FORMAT(SUM(CASE WHEN DATE(od.closing_date) = CURDATE() THEN od.sales_price ELSE 0 END), 0)) as 'Revenue Today'
          FROM escrow_officers eo
          LEFT JOIN pct_order_details od ON eo.id = od.escrow_officer
          WHERE eo.active = 1
          AND eo.branch_location LIKE '%Escrow%'
          GROUP BY eo.id, eo.first_name, eo.last_name, eo.branch_location
          ORDER BY eo.branch_location, eo.closing_efficiency DESC;
        transforms: []

  - name: 'Title Officer Performance'
    subtables:
      - id: 'title_officer_performance'
        title: 'Title Officer Production Analysis'
        sql: |
          SELECT 
            CONCAT(to.first_name, ' ', to.last_name) as 'Title Officer',
            to.branch_location as 'Branch',
            CONCAT(FORMAT(to.quality_rating, 1), '%') as 'Quality Rating',
            COUNT(CASE WHEN DATE(od.closing_date) = CURDATE() AND od.transaction_type = 'resale' THEN 1 END) as 'Resale Today',
            COUNT(CASE WHEN DATE(od.closing_date) = CURDATE() AND od.transaction_type = 'refinance' THEN 1 END) as 'Refinance Today',
            COUNT(CASE WHEN DATE(od.closing_date) = CURDATE() AND od.transaction_type = 'commercial' THEN 1 END) as 'Commercial Today',
            CONCAT('$', FORMAT(SUM(CASE WHEN DATE(od.closing_date) = CURDATE() THEN od.sales_price ELSE 0 END), 0)) as 'Revenue Today'
          FROM title_officers to
          LEFT JOIN pct_order_details od ON to.id = od.title_officer
          WHERE to.active = 1
          AND to.branch_location LIKE '%Title%'
          GROUP BY to.id, to.first_name, to.last_name, to.branch_location
          ORDER BY to.branch_location, to.quality_rating DESC;
        transforms: []